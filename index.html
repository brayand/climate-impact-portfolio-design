<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Impact Portfolio Optimization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            color: #1a1a1a;
            line-height: 1.6;
        }
        
        .page-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
        }
        
        .header {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            padding: 60px 80px;
            border-bottom: 3px solid #81c784;
        }
        
        .header-content {
            max-width: 900px;
        }
        
        .company-name {
            font-family: 'Crimson Pro', serif;
            font-size: 16px;
            font-weight: 300;
            color: #81c784;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 20px;
        }
        
        .report-title {
            font-family: 'Crimson Pro', serif;
            font-size: 42px;
            font-weight: 300;
            color: white;
            line-height: 1.2;
            margin-bottom: 15px;
        }
        
        .report-subtitle {
            font-size: 18px;
            color: rgba(255,255,255,0.8);
            font-weight: 300;
            line-height: 1.5;
        }
        
        .date-stamp {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 13px;
            color: rgba(255,255,255,0.6);
            font-weight: 300;
        }
        
        .content {
            padding: 60px 80px;
        }
        
        .section {
            margin-bottom: 60px;
        }
        
        .section-title {
            font-family: 'Crimson Pro', serif;
            font-size: 28px;
            font-weight: 600;
            color: #1b5e20;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .subsection-title {
            font-family: 'Crimson Pro', serif;
            font-size: 20px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
            margin-top: 20px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .section-subtitle {
            font-size: 14px;
            color: #666;
            font-weight: 300;
            margin-bottom: 30px;
        }
        
        .subsection-subtitle {
            font-size: 13px;
            color: #666;
            font-weight: 300;
            margin-bottom: 20px;
        }
        
        .objectives-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-left: 4px solid #1b5e20;
            padding: 40px;
            margin-bottom: 50px;
        }
        
        .objectives-title {
            font-family: 'Crimson Pro', serif;
            font-size: 28px;
            font-weight: 600;
            color: #1b5e20;
            margin-bottom: 25px;
        }
        
        .objectives-content {
            font-size: 14px;
            color: #333;
            line-height: 1.8;
        }
        
        .objectives-content p {
            margin-bottom: 15px;
        }
        
        .objectives-list {
            margin: 20px 0;
            padding-left: 0;
            list-style: none;
        }
        
        .objectives-list li {
            padding: 12px 0 12px 35px;
            position: relative;
            margin-bottom: 8px;
        }
        
        .objectives-list li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #2e7d32;
            font-weight: 600;
            font-size: 18px;
        }
        
        .objectives-list li strong {
            color: #1b5e20;
            font-weight: 600;
        }
        
        .controls-panel {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            padding: 30px;
            margin-bottom: 40px;
        }
        
        .controls-title {
            font-family: 'Crimson Pro', serif;
            font-size: 18px;
            font-weight: 600;
            color: #1b5e20;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: grid;
            grid-template-columns: 250px 150px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .control-label {
            font-size: 13px;
            color: #333;
            font-weight: 400;
        }
        
        .control-input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            background: white;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            transition: border-color 0.2s;
        }
        
        .control-input:focus {
            outline: none;
            border-color: #1b5e20;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            background: #1b5e20;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #2e7d32;
        }
        
        .btn-secondary {
            background: white;
            color: #1b5e20;
            border: 1px solid #1b5e20;
        }
        
        .btn-secondary:hover {
            background: #1b5e20;
            color: white;
        }
        
        .portfolio-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 50px;
        }
        
        .portfolio-card {
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        .card-header {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .card-title {
            font-family: 'Crimson Pro', serif;
            font-size: 20px;
            font-weight: 600;
            color: #1b5e20;
        }
        
        .card-body {
            padding: 30px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }
        
        .metric {
            padding: 20px;
            background: #fafafa;
            border-left: 3px solid #66bb6a;
        }
        
        .metric-value {
            font-family: 'Crimson Pro', serif;
            font-size: 32px;
            font-weight: 600;
            color: #1b5e20;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
            font-size: 12px;
        }
        
        .data-table thead {
            background: #1b5e20;
            color: white;
        }
        
        .data-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .data-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tbody tr:nth-child(even) {
            background: #fafafa;
        }
        
        .correlation-matrix-container {
            overflow-x: auto;
            margin: 30px 0;
        }
        
        .correlation-matrix {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin: 20px 0;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .correlation-matrix th {
            background: #1b5e20;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: 500;
            font-size: 10px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .correlation-matrix th:first-child {
            position: sticky;
            left: 0;
            z-index: 11;
            background: #1b5e20;
        }
        
        .correlation-matrix td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #e8e8e8;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .correlation-matrix td:first-child {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            padding-left: 12px;
            position: sticky;
            left: 0;
            z-index: 5;
            font-size: 10px;
            color: #333;
        }
        
        .correlation-cell {
            cursor: pointer;
            position: relative;
        }
        
        .correlation-cell:hover {
            transform: scale(1.15);
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border-radius: 3px;
        }
        
        .correlation-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .correlation-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #333;
        }
        
        .correlation-legend-color {
            width: 30px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 2px;
        }
        
        .correlation-matrix-insight {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8eaf0 100%);
            border-left: 4px solid #66bb6a;
            padding: 25px;
            margin: 30px 0;
        }
        
        .correlation-matrix-insight h4 {
            font-family: 'Crimson Pro', serif;
            font-size: 16px;
            font-weight: 600;
            color: #1b5e20;
            margin-bottom: 12px;
        }
        
        .correlation-matrix-insight p {
            font-size: 12px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        
        .weight-viz {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weight-bar-container {
            flex: 1;
            height: 6px;
            background: #e8e8e8;
            position: relative;
            overflow: hidden;
        }
        
        .weight-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #66bb6a, #81c784);
            transition: width 0.3s ease;
        }
        
        .weight-percentage {
            font-weight: 500;
            color: #1b5e20;
            min-width: 50px;
            text-align: right;
        }
        
        .change-indicator {
            padding: 3px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .change-positive {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .change-negative {
            background: #ffebee;
            color: #c62828;
        }
        
        .chart-container {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 40px;
            margin: 40px 0;
        }
        
        .chart-title {
            font-family: 'Crimson Pro', serif;
            font-size: 22px;
            font-weight: 600;
            color: #1b5e20;
            margin-bottom: 10px;
        }
        
        .chart-description {
            font-size: 13px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .insight-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8eaf0 100%);
            border-left: 4px solid #66bb6a;
            padding: 30px;
            margin: 30px 0;
        }
        
        .insight-title {
            font-family: 'Crimson Pro', serif;
            font-size: 18px;
            font-weight: 600;
            color: #1b5e20;
            margin-bottom: 15px;
        }
        
        .insight-text {
            font-size: 13px;
            color: #333;
            line-height: 1.7;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            background: #e0e0e0;
            border: 1px solid #e0e0e0;
            margin: 30px 0;
        }
        
        .summary-item {
            background: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        .summary-value {
            font-family: 'Crimson Pro', serif;
            font-size: 28px;
            font-weight: 600;
            color: #1b5e20;
            margin-bottom: 8px;
        }
        
        .summary-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin: 30px 0;
            padding: 20px;
            background: #fafafa;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #333;
        }
        
        .legend-symbol {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        .footer {
            background: #1b5e20;
            padding: 40px 80px;
            color: rgba(255,255,255,0.7);
            font-size: 11px;
            line-height: 1.8;
        }
        
        .footer-title {
            font-family: 'Crimson Pro', serif;
            font-size: 14px;
            color: #81c784;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        @media print {
            .controls-panel, .btn-group {
                display: none;
            }
        }
        
        @media (max-width: 1024px) {
            .header, .content, .footer {
                padding: 40px;
            }
            
            .portfolio-comparison {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="header">
            <div class="header-content">
                <div class="company-name">Climate Investment Analytics</div>
                <h1 class="report-title">Minimum Variance Portfolio Optimization</h1>
                <p class="report-subtitle">Quantitative Analysis of Risk-Adjusted Climate Impact Returns for Renewable Energy Infrastructure Investments</p>
                <div class="date-stamp">Analysis Date: November 2025 | Portfolio Value: $357M | Asset Universe: 15 Investments</div>
            </div>
        </div>
        
        <div class="content">
            <div class="section">
                <h2 class="section-title">Project Objectives</h2>
                <p class="section-subtitle"></p>
                <div class="objectives-content">
                    <p>This Climate Impact Portfolio Optimization project applies quantitative portfolio theory to renewable energy infrastructure investments, enabling data-driven decision-making for maximizing climate impact while managing risk when building portfolios. The primary goals of this analysis are:</p>
                    
                    <ul class="objectives-list">
                        <li><strong>Optimize Portfolio Risk-Adjusted Returns:</strong> Apply Modern Portfolio Theory (MPT) principles to construct minimum variance portfolios that maximize climate impact (measured in CO2e reduction) while minimizing portfolio-level risk through strategic diversification.</li>
                        
                        <li><strong>Quantify Climate Impact Performance:</strong> Translate traditional financial metrics into climate impact measurements, evaluating investments based on expected CO2e reduction (impact), variance (risk), and risk-adjusted ratios (Sharpe ratio).</li>
                        
                        <li><strong>Enable Data-Driven Allocation Decisions:</strong> Provide interactive tools and visualizations that allow portfolio managers to understand the trade-offs between risk and impact, compare optimization strategies, and make informed capital allocation decisions.</li>
                        
                        <li><strong>Demonstrate Diversification Benefits:</strong> Illustrate how correlation analysis and portfolio optimization can achieve superior risk-adjusted performance compared to equal-weight or single-asset strategies, highlighting the value of diversification in climate impact investing.</li>
                        
                        <li><strong>Support Stakeholder Communication:</strong> Generate clear, professional reports with actionable insights including P90 estimates, efficient frontier analysis, and risk-return visualizations that facilitate transparent communication with investors, stakeholders, and regulatory bodies.</li>
                        
                        <li><strong>Enable Scenario Analysis:</strong> Allow portfolio managers to test different optimization parameters (minimum return targets, weight constraints) and visualize outcomes through efficient frontier generation, supporting strategic planning and risk management.</li>
                    </ul>
                    
                    <p>By combining rigorous quantitative analysis with climate impact measurement, this project bridges the gap between traditional portfolio optimization and sustainable investing, providing a framework for making investment decisions that align financial performance with environmental objectives.</p>
                </div>
            </div>
            <div class="section">
                <h2 class="section-title">Original Portfolio</h2>
                <p class="section-subtitle">Details of Original Portfolio</p>
                
                <table class="data-table" id="originalPortfolioTable"></table>
                <div class="portfolio-comparison">
                    <div class="portfolio-card">
                        <div class="card-header">
                            <h3 class="card-title">Original Portfolio</h3>
                        </div>
                        <div class="card-body">
                            <div class="metrics-grid" id="originalMetrics"></div>
                        </div>
                    </div>
                    
                    <div class="portfolio-card">
                        <div class="card-header">
                            <h3 class="card-title" >Sector Allocation</h3>
                        </div>
                        <div class="card-body">
                            <div id="sectorAllocationChart"></div>
                        </div>
                    </div>
                </div>
                
                <h3 class="subsection-title">Correlation Matrix</h3>
                <p class="subsection-subtitle">Investment Correlation Analysis: Understanding Diversification Opportunities and Risk Interdependencies</p>
                
                <div id="correlationMatrixContainer"></div>
            </div>

            <div class="section">
                <h2 class="section-title">Optimized Portfolio</h2>
                <p class="section-subtitle">Creating a Minimum Variance optimized portfolio</p>
                <div class="controls-panel">
                    <h3 class="controls-title">Optimization Parameters</h3>
                    <div class="control-group">
                        <label class="control-label">Minimum Return Target (M tons CO2e/year)</label>
                        <input type="number" id="minReturn" class="control-input" value="30" step="1">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Maximum Single Investment Weight</label>
                        <input type="number" id="maxWeight" class="control-input" value="0.15" step="0.01" min="0.05" max="0.5">
                    </div>
                    <div class="control-group">
                        <label class="control-label">Minimum Single Investment Weight</label>
                        <input type="number" id="minWeight" class="control-input" value="0.02" step="0.01" min="0" max="0.1">
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="reoptimize()">Reoptimize Portfolio</button>
                        <button class="btn btn-secondary" onclick="generateEfficientFrontier()">Generate Efficient Frontier</button>
                    </div>
                </div>
                
                <h3 class="subsection-title">Portfolio Allocation Analysis</h3>
                <p class="subsection-subtitle">Detailed Comparison of Investment Weights and Capital Allocation</p>
                
                <table class="data-table" id="weightsTable"></table>
            </div>
            
            <div class="section">
                <h3 class="subsection-title">Optimization Results</h3>
                <p class="subsection-subtitle">Comparative Analysis of Equal-Weight vs. Minimum Variance Allocation Strategy</p>
                
                
                
                <div id="metricChanges" style="margin-top: 40px;"></div>
                
                <div class="insight-box">
                    <h4 class="insight-title">Key Findings</h4>
                    <div class="insight-text" id="optimizationSummary"></div>
                </div>
                
                <h3 class="subsection-title">Impact and Risk Contributions</h3>
                <p class="subsection-subtitle">Individual Investment Characteristics with Portfolio-Level Optimization Impact</p>
                
                <div id="riskReturnAnalysis"></div>
            </div>
            
            <div class="section">
                <div id="efficientFrontierContainer"></div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Future Work</h2>
                <p class="section-subtitle">Potential Enhancements and Extensions to the Climate Impact Portfolio Optimization Framework</p>
                
                <div class="objectives-content">
                    <p>The current implementation provides a solid foundation for climate impact portfolio optimization, but there are several opportunities for enhancement and extension:</p>
                    
                    <ul class="objectives-list">
                        <li><strong>Dynamic Correlation Modeling:</strong> Implement time-varying correlation matrices that capture changing relationships between investments as markets evolve and technologies mature. This could incorporate regime-switching models or machine learning approaches to predict correlation structures.</li>
                        
                        <li><strong>Multi-Objective Optimization:</strong> Expand beyond minimum variance optimization to include multiple objectives simultaneously, such as maximizing impact while minimizing risk and maintaining liquidity constraints. This would enable Pareto frontier analysis across impact, risk, and return dimensions.</li>
                        
                        <li><strong>Real-Time Data Integration:</strong> Integrate live data feeds from climate impact measurement platforms, carbon markets, and renewable energy markets to enable real-time portfolio rebalancing based on current market conditions and impact metrics.</li>
                        
                        <li><strong>Scenario Analysis and Stress Testing:</strong> Develop comprehensive scenario analysis capabilities that model portfolio performance under various climate scenarios (e.g., different carbon pricing regimes, policy changes, technology breakthroughs) to assess resilience and adaptability.</li>
                        
                        <li><strong>ESG Integration:</strong> Incorporate broader Environmental, Social, and Governance (ESG) factors beyond carbon impact, including biodiversity, water usage, social impact metrics, and governance scores to create a more holistic sustainability assessment framework.</li>
                        
                        <li><strong>Machine Learning Enhancements:</strong> Apply machine learning techniques to improve impact prediction accuracy, optimize feature selection for risk modeling, and develop more sophisticated portfolio optimization algorithms that can handle non-linear relationships and complex constraints.</li>
                        
                        <li><strong>Interactive Portfolio Builder:</strong> Create a user-friendly interactive interface that allows portfolio managers to manually adjust allocations, visualize trade-offs in real-time, and explore "what-if" scenarios with immediate feedback on impact and risk metrics.</li>
                        
                        <li><strong>Performance Attribution Analysis:</strong> Implement detailed performance attribution that decomposes portfolio returns and impact into contributions from sector selection, investment selection, timing decisions, and optimization effects to better understand sources of value creation.</li>
                    </ul>
                    
                    <p style="margin-top: 25px;">These enhancements would strengthen the framework's analytical capabilities, improve decision-making support, and enable more sophisticated climate impact investing strategies that align financial performance with environmental objectives.</p>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <div class="footer-title">Important Disclosures</div>
            <p>This analysis employs Modern Portfolio Theory principles adapted for climate impact measurement. Portfolio optimization utilizes quadratic programming with correlation-adjusted covariance matrices. P90 values calculated as Mean + 1.28σ assuming normal distribution of returns. Historical performance and correlations may not predict future results.</p>
            <p style="margin-top: 15px;">This report is for illustrative and educational purposes only and does not constitute investment advice, a recommendation, or an offer or solicitation to buy or sell any securities or investment products. Climate impact investing involves substantial risks including project execution risk, policy risk, technology risk, and market risk.</p>
            <p style="margin-top: 15px;">© 2025 Climate Investment Analytics. All rights reserved. Confidential and proprietary information.</p>
        </div>
    </div>

    <script>
        // Investment data
                // Investment portfolio data as JavaScript array of objects
                const investments = [
            {
                id: 1,
                name: "SolarTech Global Fund",
                sector: "Solar Energy",
                amount: 25,
                description: "Utility-scale solar installations in Southeast Asia",
                impactType: "GHG Reduction",
                potentialImpact: "2.5M tons CO2e/year",
                impactValue: 2.5,
                impactVariance: "±0.3M tons",
                variance: 0.3,
                correlations: "High: #2,#3,#4"
            },
            {
                id: 2,
                name: "WindPower Emerging Markets",
                sector: "Wind Energy",
                amount: 30,
                description: "Onshore and offshore wind farms in Latin America",
                impactType: "GHG Reduction",
                potentialImpact: "3.2M tons CO2e/year",
                impactValue: 3.2,
                impactVariance: "±0.4M tons",
                variance: 0.4,
                correlations: "High: #1,#3 | Med: #15"
            },
            {
                id: 3,
                name: "Hydroelectric Development Corp",
                sector: "Hydroelectric",
                amount: 20,
                description: "Small-scale run-of-river hydro projects in Africa",
                impactType: "GHG Reduction",
                potentialImpact: "1.8M tons CO2e/year",
                impactValue: 1.8,
                impactVariance: "±0.2M tons",
                variance: 0.2,
                correlations: "Med: #1,#2 | High: #6"
            },
            {
                id: 4,
                name: "Geothermal Energy Ventures",
                sector: "Geothermal",
                amount: 18,
                description: "Enhanced geothermal systems in volcanic regions",
                impactType: "GHG Reduction",
                potentialImpact: "2.1M tons CO2e/year",
                impactValue: 2.1,
                impactVariance: "±0.15M tons",
                variance: 0.15,
                correlations: "Low correlation"
            },
            {
                id: 5,
                name: "Community Solar Initiative",
                sector: "Distributed Solar",
                amount: 15,
                description: "Rooftop and community solar in underserved communities",
                impactType: "Energy Access + GHG",
                potentialImpact: "1.2M tons CO2e/year + 50k households",
                impactValue: 1.2,
                impactVariance: "±0.2M tons",
                variance: 0.2,
                correlations: "Med: #1 | High: #41"
            },
            {
                id: 6,
                name: "Micro-Hydro Rural Electrification",
                sector: "Small Hydro",
                amount: 12,
                description: "Village-scale hydro systems in mountainous regions",
                impactType: "Energy Access",
                potentialImpact: "200k people with clean electricity",
                impactValue: null,
                impactVariance: "±30k people",
                variance: null,
                correlations: "High: #3,#5"
            },
            {
                id: 7,
                name: "Floating Solar Platforms",
                sector: "Floating Solar",
                amount: 22,
                description: "Solar installations on water bodies to reduce evaporation",
                impactType: "GHG + Water Conservation",
                potentialImpact: "2.0M tons CO2e/year + 15% water savings",
                impactValue: 2.0,
                impactVariance: "±0.3M tons",
                variance: 0.3,
                correlations: "Med: #1,#5,#8"
            },
            {
                id: 8,
                name: "Smart Grid Integration Fund",
                sector: "Grid Infrastructure",
                amount: 16,
                description: "AI-powered grid optimization for renewable integration",
                impactType: "Energy Efficiency",
                potentialImpact: "1.5M tons CO2e/year (5% efficiency)",
                impactValue: 1.5,
                impactVariance: "±0.4M tons",
                variance: 0.4,
                correlations: "High: All renewables"
            },
            {
                id: 9,
                name: "Biomass Energy Cooperative",
                sector: "Biomass",
                amount: 14,
                description: "Agricultural waste-to-energy plants",
                impactType: "GHG + Waste Management",
                potentialImpact: "1.1M tons CO2e/year + waste diversion",
                impactValue: 1.1,
                impactVariance: "±0.2M tons",
                variance: 0.2,
                correlations: "High: #17 | Med: #19"
            },
            {
                id: 10,
                name: "Tidal Energy Development",
                sector: "Marine Energy",
                amount: 25,
                description: "Tidal and wave energy systems in coastal areas",
                impactType: "GHG Reduction",
                potentialImpact: "2.3M tons CO2e/year",
                impactValue: 2.3,
                impactVariance: "±0.25M tons",
                variance: 0.25,
                correlations: "Low correlation | Med: coastal"
            },
            {
                id: 11,
                name: "Solar-Plus-Storage Systems",
                sector: "Solar + Storage",
                amount: 28,
                description: "Integrated solar and battery systems",
                impactType: "GHG + Grid Stability",
                potentialImpact: "2.8M tons CO2e/year + resilience",
                impactValue: 2.8,
                impactVariance: "±0.35M tons",
                variance: 0.35,
                correlations: "High: #1,#5,#15"
            },
            {
                id: 12,
                name: "Wind-Solar Hybrid Parks",
                sector: "Hybrid Renewables",
                amount: 32,
                description: "Co-located wind and solar with shared infrastructure",
                impactType: "GHG Reduction",
                potentialImpact: "3.5M tons CO2e/year",
                impactValue: 3.5,
                impactVariance: "±0.4M tons",
                variance: 0.4,
                correlations: "High: #1,#2"
            },
            {
                id: 13,
                name: "Green Hydrogen Production",
                sector: "Hydrogen",
                amount: 35,
                description: "Electrolysis plants powered by renewable energy",
                impactType: "Industrial Decarbonization",
                potentialImpact: "2.2M tons CO2e/year (replacing grey H2)",
                impactValue: 2.2,
                impactVariance: "±0.5M tons",
                variance: 0.5,
                correlations: "Med: renewables | High: #29"
            },
            {
                id: 14,
                name: "Renewable Energy Certificates Trading",
                sector: "Carbon Markets",
                amount: 8,
                description: "Platform for trading renewable energy certificates",
                impactType: "Market Development",
                potentialImpact: "Enable 5M tons CO2e/year market efficiency",
                impactValue: 5.0,
                impactVariance: "±1M tons",
                variance: 1.0,
                correlations: "Med: All renewables"
            },
            {
                id: 15,
                name: "Grid-Scale Battery Storage",
                sector: "Energy Storage",
                amount: 40,
                description: "Lithium-ion and alternative battery systems",
                impactType: "Grid Stability + Renewable Integration",
                potentialImpact: "Enable 4M tons CO2e/year renewable integration",
                impactValue: 4.0,
                impactVariance: "±0.6M tons",
                variance: 0.6,
                correlations: "High: #1,#2,#7,#10,#12"
            }
        ];


        const correlationMatrix = [
            [1.00, 0.75, 0.65, 0.25, 0.70, 0.35, 0.80, 0.55, 0.40, 0.30, 0.75, 0.85, 0.35, 0.50, 0.60],
            [0.75, 1.00, 0.55, 0.20, 0.50, 0.30, 0.80, 0.60, 0.35, 0.25, 0.65, 0.90, 0.40, 0.55, 0.65],
            [0.65, 0.55, 1.00, 0.30, 0.45, 0.75, 0.50, 0.45, 0.50, 0.35, 0.55, 0.60, 0.25, 0.40, 0.50],
            [0.25, 0.20, 0.30, 1.00, 0.30, 0.25, 0.20, 0.35, 0.30, 0.15, 0.30, 0.25, 0.40, 0.35, 0.40],
            [0.70, 0.50, 0.45, 0.30, 1.00, 0.40, 0.75, 0.50, 0.35, 0.25, 0.80, 0.65, 0.30, 0.45, 0.55],
            [0.35, 0.30, 0.75, 0.25, 0.40, 1.00, 0.30, 0.35, 0.45, 0.20, 0.40, 0.35, 0.20, 0.30, 0.35],
            [0.80, 0.80, 0.50, 0.20, 0.75, 0.30, 1.00, 0.55, 0.35, 0.30, 0.85, 0.75, 0.30, 0.50, 0.60],
            [0.55, 0.60, 0.45, 0.35, 0.50, 0.35, 0.55, 1.00, 0.40, 0.30, 0.70, 0.65, 0.60, 0.70, 0.80],
            [0.40, 0.35, 0.50, 0.30, 0.35, 0.45, 0.35, 0.40, 1.00, 0.25, 0.40, 0.40, 0.55, 0.60, 0.45],
            [0.30, 0.25, 0.35, 0.15, 0.25, 0.20, 0.30, 0.30, 0.25, 1.00, 0.35, 0.30, 0.25, 0.40, 0.35],
            [0.75, 0.65, 0.55, 0.30, 0.80, 0.40, 0.85, 0.70, 0.40, 0.35, 1.00, 0.75, 0.45, 0.55, 0.85],
            [0.85, 0.90, 0.60, 0.25, 0.65, 0.35, 0.75, 0.65, 0.40, 0.30, 0.75, 1.00, 0.40, 0.55, 0.70],
            [0.35, 0.40, 0.25, 0.40, 0.30, 0.20, 0.30, 0.60, 0.55, 0.25, 0.45, 0.40, 1.00, 0.65, 0.70],
            [0.50, 0.55, 0.40, 0.35, 0.45, 0.30, 0.50, 0.70, 0.60, 0.40, 0.55, 0.55, 0.65, 1.00, 0.60],
            [0.60, 0.65, 0.50, 0.40, 0.55, 0.35, 0.60, 0.80, 0.45, 0.35, 0.85, 0.70, 0.70, 0.60, 1.00]
        ];

        let currentOptimizedWeights = null;
        let currentOptimizedReturn = null;
        let currentOptimizedRisk = null;

        function calculateCovarianceMatrix() {
            const n = investments.length;
            const covMatrix = [];
            
            for (let i = 0; i < n; i++) {
                covMatrix[i] = [];
                for (let j = 0; j < n; j++) {
                    const varI = investments[i].variance || 0.1;
                    const varJ = investments[j].variance || 0.1;
                    covMatrix[i][j] = correlationMatrix[i][j] * varI * varJ;
                }
            }
            return covMatrix;
        }

        function calculatePortfolioVariance(weights, covMatrix) {
            const n = weights.length;
            let variance = 0;
            
            for (let i = 0; i < n; i++) {
                for (let j = 0; j < n; j++) {
                    variance += weights[i] * weights[j] * covMatrix[i][j];
                }
            }
            return Math.sqrt(variance);
        }

        function calculatePortfolioReturn(weights) {
            return weights.reduce((sum, w, i) => sum + w * (investments[i].impactValue || 0), 0);
        }

        function calculateP90(mean, stdDev) {
            return mean + 1.28 * stdDev;
        }

        function optimizePortfolio() {
            const minReturn = parseFloat(document.getElementById('minReturn').value);
            const maxWeight = parseFloat(document.getElementById('maxWeight').value);
            const minWeight = parseFloat(document.getElementById('minWeight').value);
            
            const covMatrix = calculateCovarianceMatrix();
            const n = investments.length;
            
            let weights = new Array(n).fill(1/n);
            const learningRate = 0.001;
            const iterations = 5000;
            
            for (let iter = 0; iter < iterations; iter++) {
                const gradient = new Array(n).fill(0);
                
                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < n; j++) {
                        gradient[i] += 2 * weights[j] * covMatrix[i][j];
                    }
                }
                
                for (let i = 0; i < n; i++) {
                    weights[i] -= learningRate * gradient[i];
                    weights[i] = Math.max(minWeight, Math.min(maxWeight, weights[i]));
                }
                
                const sum = weights.reduce((a, b) => a + b, 0);
                weights = weights.map(w => w / sum);
                
                const currentReturn = calculatePortfolioReturn(weights);
                if (currentReturn < minReturn) {
                    const returns = investments.map(inv => inv.impactValue || 0);
                    const maxReturn = Math.max(...returns);
                    for (let i = 0; i < n; i++) {
                        weights[i] += learningRate * (returns[i] / maxReturn) * 0.1;
                    }
                    
                    const newSum = weights.reduce((a, b) => a + b, 0);
                    weights = weights.map(w => w / newSum);
                }
            }
            
            displayResults(weights);
        }

        function displayResults(optimizedWeights) {
            const covMatrix = calculateCovarianceMatrix();
            const totalAmount = investments.reduce((sum, inv) => sum + inv.amount, 0);
            
            const originalWeights = investments.map(inv => inv.amount / totalAmount);
            const originalReturn = calculatePortfolioReturn(originalWeights);
            const originalVariance = calculatePortfolioVariance(originalWeights, covMatrix);
            const originalSharpe = originalReturn / originalVariance;
            
            const optimizedReturn = calculatePortfolioReturn(optimizedWeights);
            const optimizedVariance = calculatePortfolioVariance(optimizedWeights, covMatrix);
            const optimizedSharpe = optimizedReturn / optimizedVariance;
            
            currentOptimizedWeights = optimizedWeights;
            currentOptimizedReturn = optimizedReturn;
            currentOptimizedRisk = optimizedVariance;
            
            displayMetrics('originalMetrics', originalReturn, originalVariance, originalSharpe, totalAmount);
            
            displayMetricChanges(originalReturn, originalVariance, originalSharpe, optimizedReturn, optimizedVariance, optimizedSharpe);
            displayOptimizationSummary(originalReturn, originalVariance, originalSharpe, 
                                      optimizedReturn, optimizedVariance, optimizedSharpe);
            displayOriginalPortfolioTable(originalWeights, totalAmount);
            displaySectorAllocationChart(originalWeights);
            displayWeightsTable(originalWeights, optimizedWeights, totalAmount);
            displayRiskReturnAnalysis(originalWeights, optimizedWeights, covMatrix);
        }

        function displayMetrics(containerId, returns, variance, sharpe, totalAmount) {
            const container = document.getElementById(containerId);
            const p90Return = calculateP90(returns, variance);
            const p10Return = returns - 1.28 * variance;
            
            container.innerHTML = `
                <div class="metric">
                    <div class="metric-value">${returns.toFixed(2)}M</div>
                    <div class="metric-label">Expected Impact</div>
                </div>
                <div class="metric">
                    <div class="metric-value">±${variance.toFixed(2)}M</div>
                    <div class="metric-label">Risk (Std Dev)</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${p90Return.toFixed(2)}M</div>
                    <div class="metric-label">P90 Impact</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${sharpe.toFixed(2)}</div>
                    <div class="metric-label">Sharpe Ratio</div>
                </div>
            `;
        }

        function displayMetricChanges(origReturn, origVar, origSharpe, optReturn, optVar, optSharpe) {
            const origP90 = calculateP90(origReturn, origVar);
            const optP90 = calculateP90(optReturn, optVar);
            
            const returnChange = optReturn - origReturn;
            const varChange = optVar - origVar;
            const p90Change = optP90 - origP90;
            const sharpeChange = optSharpe - origSharpe;
            
            const returnChangePct = ((returnChange / origReturn) * 100).toFixed(1);
            const varChangePct = ((varChange / origVar) * 100).toFixed(1);
            const p90ChangePct = ((p90Change / origP90) * 100).toFixed(1);
            const sharpeChangePct = ((sharpeChange / origSharpe) * 100).toFixed(1);
            
            const container = document.getElementById('metricChanges');
            if (!container) return;
            
            container.innerHTML = `
                <h3 class="subsection-title" style="margin-top: 0;">Portfolio Metrics Comparison</h3>
                <p class="subsection-subtitle">Changes from Original Portfolio to Optimized Portfolio</p>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-top: 30px;">
                    <div style="background: white; border: 1px solid #e0e0e0; padding: 30px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Expected Impact</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px;">
                            <div style="font-family: 'Crimson Pro', serif; font-size: 24px; font-weight: 600; color: #666;">${origReturn.toFixed(2)}M</div>
                            <div style="display: flex; align-items: center; justify-content: center; flex: 0 0 auto;">
                                <svg width="60" height="20" viewBox="0 0 60 20" style="display: block; margin: 0 auto;">
                                    <defs>
                                        <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
                                            <polygon points="0 0, 8 4, 0 8" fill="#1b5e20" />
                                        </marker>
                                    </defs>
                                    <line x1="0" y1="10" x2="50" y2="10" stroke="#1b5e20" stroke-width="2" marker-end="url(#arrowhead)"/>
                                </svg>
                            </div>
                            <div style="font-family: 'Crimson Pro', serif; font-size: 24px; font-weight: 600; color: #1b5e20;">${optReturn.toFixed(2)}M</div>
                        </div>
                        <div style="font-size: 12px; color: ${returnChange >= 0 ? '#2e7d32' : '#c62828'}; font-weight: 500; text-align: center;">
                            ${returnChange >= 0 ? '+' : ''}${returnChange.toFixed(2)}M (${returnChangePct >= 0 ? '+' : ''}${returnChangePct}%)
                        </div>
                    </div>
                    
                    <div style="background: white; border: 1px solid #e0e0e0; padding: 30px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Risk (Std Dev)</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px;">
                            <div style="font-family: 'Crimson Pro', serif; font-size: 24px; font-weight: 600; color: #666;">±${origVar.toFixed(2)}M</div>
                            <div style="display: flex; align-items: center; justify-content: center; flex: 0 0 auto;">
                                <svg width="60" height="20" viewBox="0 0 60 20" style="display: block; margin: 0 auto;">
                                    <defs>
                                        <marker id="arrowhead-risk" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
                                            <polygon points="0 0, 8 4, 0 8" fill="#2e7d32" />
                                        </marker>
                                    </defs>
                                    <line x1="0" y1="10" x2="50" y2="10" stroke="#2e7d32" stroke-width="2" marker-end="url(#arrowhead-risk)"/>
                                </svg>
                            </div>
                            <div style="font-family: 'Crimson Pro', serif; font-size: 24px; font-weight: 600; color: #1b5e20;">±${optVar.toFixed(2)}M</div>
                        </div>
                        <div style="font-size: 12px; color: ${varChange <= 0 ? '#2e7d32' : '#c62828'}; font-weight: 500; text-align: center;">
                            ${varChange >= 0 ? '+' : ''}${varChange.toFixed(2)}M (${varChangePct >= 0 ? '+' : ''}${varChangePct}%)
                            ${varChange <= 0 ? '↓ Risk Reduction' : '↑ Risk Increase'}
                        </div>
                    </div>
                    
                    <div style="background: white; border: 1px solid #e0e0e0; padding: 30px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">P90 Impact</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px;">
                            <div style="font-family: 'Crimson Pro', serif; font-size: 24px; font-weight: 600; color: #666;">${origP90.toFixed(2)}M</div>
                            <div style="display: flex; align-items: center; justify-content: center; flex: 0 0 auto;">
                                <svg width="60" height="20" viewBox="0 0 60 20" style="display: block; margin: 0 auto;">
                                    <defs>
                                        <marker id="arrowhead-p90" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
                                            <polygon points="0 0, 8 4, 0 8" fill="#1b5e20" />
                                        </marker>
                                    </defs>
                                    <line x1="0" y1="10" x2="50" y2="10" stroke="#1b5e20" stroke-width="2" marker-end="url(#arrowhead-p90)"/>
                                </svg>
                            </div>
                            <div style="font-family: 'Crimson Pro', serif; font-size: 24px; font-weight: 600; color: #1b5e20;">${optP90.toFixed(2)}M</div>
                        </div>
                        <div style="font-size: 12px; color: ${p90Change >= 0 ? '#2e7d32' : '#c62828'}; font-weight: 500; text-align: center;">
                            ${p90Change >= 0 ? '+' : ''}${p90Change.toFixed(2)}M (${p90ChangePct >= 0 ? '+' : ''}${p90ChangePct}%)
                        </div>
                    </div>
                    
                    <div style="background: white; border: 1px solid #e0e0e0; padding: 30px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">Sharpe Ratio</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px;">
                            <div style="font-family: 'Crimson Pro', serif; font-size: 24px; font-weight: 600; color: #666;">${origSharpe.toFixed(2)}</div>
                            <div style="display: flex; align-items: center; justify-content: center; flex: 0 0 auto;">
                                <svg width="60" height="20" viewBox="0 0 60 20" style="display: block; margin: 0 auto;">
                                    <defs>
                                        <marker id="arrowhead-sharpe" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
                                            <polygon points="0 0, 8 4, 0 8" fill="#1b5e20" />
                                        </marker>
                                    </defs>
                                    <line x1="0" y1="10" x2="50" y2="10" stroke="#1b5e20" stroke-width="2" marker-end="url(#arrowhead-sharpe)"/>
                                </svg>
                            </div>
                            <div style="font-family: 'Crimson Pro', serif; font-size: 24px; font-weight: 600; color: #1b5e20;">${optSharpe.toFixed(2)}</div>
                        </div>
                        <div style="font-size: 12px; color: ${sharpeChange >= 0 ? '#2e7d32' : '#c62828'}; font-weight: 500; text-align: center;">
                            ${sharpeChange >= 0 ? '+' : ''}${sharpeChange.toFixed(2)} (${sharpeChangePct >= 0 ? '+' : ''}${sharpeChangePct}%)
                            ${sharpeChange >= 0 ? '↑ Improvement' : '↓ Decline'}
                        </div>
                    </div>
                </div>
            `;
        }

        function displayOptimizationSummary(origReturn, origVar, origSharpe, optReturn, optVar, optSharpe) {
            const returnChange = ((optReturn - origReturn) / origReturn * 100);
            const varianceChange = ((optVar - origVar) / origVar * 100);
            const sharpeChange = ((optSharpe - origSharpe) / origSharpe * 100);
            
            const origP90 = calculateP90(origReturn, origVar);
            const optP90 = calculateP90(optReturn, optVar);
            
            document.getElementById('optimizationSummary').innerHTML = `
                <p style="margin-bottom: 12px;">The optimization process achieved a <strong>${Math.abs(varianceChange).toFixed(1)}% reduction in portfolio risk</strong> while maintaining ${((optReturn/origReturn)*100).toFixed(1)}% of expected impact. The Sharpe ratio improved by <strong>${sharpeChange.toFixed(1)}%</strong>, demonstrating superior risk-adjusted performance.</p>
                
                <div class="summary-grid" style="margin-top: 20px;">
                    <div class="summary-item">
                        <div class="summary-value">${Math.abs(varianceChange).toFixed(1)}%</div>
                        <div class="summary-label">Risk Reduction</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${sharpeChange.toFixed(1)}%</div>
                        <div class="summary-label">Sharpe Improvement</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${optP90.toFixed(1)}M</div>
                        <div class="summary-label">Optimized P90</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${((2.56*origVar - 2.56*optVar)/(2.56*origVar)*100).toFixed(1)}%</div>
                        <div class="summary-label">Range Reduction</div>
                    </div>
                </div>
                
                <p style="margin-top: 20px; font-size: 12px; color: #666;">The P90 metric indicates a 90% probability of achieving at least ${optP90.toFixed(2)}M tons CO2e reduction annually, providing a conservative estimate for stakeholder reporting and risk management purposes.</p>
            `;
        }

        function displayOriginalPortfolioTable(originalWeights, totalAmount) {
            let html = `
                <thead>
                    <tr>
                        <th>Investment Name</th>
                        <th>Description</th>
                        <th style="text-align: right;">Amount</th>
                        <th>Sector</th>
                        <th style="text-align: right;">Expected Impact</th>
                        <th style="text-align: right;">Risk</th>
                        <th style="text-align: right;">Sharpe Ratio</th>
                        <th>Correlations</th>
                        <th style="text-align: center;">Original Weight</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            investments.forEach((inv, i) => {
                const origWeight = originalWeights[i];
                const impactVal = inv.impactValue || 0;
                const sharpe = impactVal / (inv.variance || 0.1);
                const sharpeColor = sharpe > 10 ? '#2e7d32' : sharpe > 7 ? '#1976d2' : sharpe > 5 ? '#f57c00' : '#c62828';
                
                html += `
                    <tr>
                        <td><strong>${inv.name}</strong></td>
                        <td>${inv.description}</td>
                        <td style="text-align: right;">$${inv.amount}M</td>
                        <td>${inv.sector}</td>
                        <td style="text-align: right;">${impactVal > 0 ? impactVal.toFixed(2) + 'M tons' : 'N/A'}</td>
                        <td style="text-align: right;">±${(inv.variance || 0.1).toFixed(2)}M</td>
                        <td style="text-align: right;">
                            <span style="color: ${sharpeColor}; font-weight: 600;">${sharpe.toFixed(2)}</span>
                        </td>
                        <td style="font-size: 11px; color: #666;">${inv.correlations}</td>
                        <td>
                            <div class="weight-viz">
                                <div class="weight-bar-container">
                                    <div class="weight-bar-fill" style="width: ${origWeight * 100}%; background: #e0e0e0;"></div>
                                </div>
                                <span class="weight-percentage">${(origWeight * 100).toFixed(1)}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody>';
            document.getElementById('originalPortfolioTable').innerHTML = html;
        }

        function displaySectorAllocationChart(weights) {
            // Calculate sector allocation
            const sectorAllocation = {};
            investments.forEach((inv, i) => {
                const sector = inv.sector;
                if (!sectorAllocation[sector]) {
                    sectorAllocation[sector] = 0;
                }
                sectorAllocation[sector] += weights[i];
            });

            // Convert to array and sort by value
            const sectors = Object.entries(sectorAllocation)
                .map(([sector, weight]) => ({ sector, weight: weight * 100 }))
                .sort((a, b) => b.weight - a.weight);

            // Color palette for sectors
            const colors = [
                '#1b5e20', '#2e7d32', '#66bb6a', '#81c784', '#a5d6a7',
                '#388e3c', '#4caf50', '#8bc34a', '#9ccc65', '#c5e1a5',
                '#558b2f', '#689f38', '#7cb342', '#9ccc65', '#aed581'
            ];

            // Create pie chart
            const container = document.getElementById('sectorAllocationChart');
            const size = 280;
            const radius = size / 2 - 10;
            const centerX = size / 2;
            const centerY = size / 2;

            let currentAngle = -Math.PI / 2; // Start at top
            let html = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="max-width: 100%; height: auto;">`;

            // Draw pie slices
            sectors.forEach((item, index) => {
                const sliceAngle = (item.weight / 100) * 2 * Math.PI;
                const startAngle = currentAngle;
                const endAngle = currentAngle + sliceAngle;

                const x1 = centerX + radius * Math.cos(startAngle);
                const y1 = centerY + radius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);

                const largeArcFlag = sliceAngle > Math.PI ? 1 : 0;

                const pathData = [
                    `M ${centerX} ${centerY}`,
                    `L ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                    'Z'
                ].join(' ');

                const color = colors[index % colors.length];
                const midAngle = startAngle + sliceAngle / 2;
                const labelRadius = radius * 0.7;
                const labelX = centerX + labelRadius * Math.cos(midAngle);
                const labelY = centerY + labelRadius * Math.sin(midAngle);

                html += `
                    <path d="${pathData}" 
                          fill="${color}" 
                          stroke="white" 
                          stroke-width="2"
                          opacity="0.9">
                        <title>${item.sector}: ${item.weight.toFixed(1)}%</title>
                    </path>
                `;

                // Add percentage label if slice is large enough
                if (item.weight > 3) {
                    html += `
                        <text x="${labelX}" y="${labelY}" 
                              text-anchor="middle" 
                              dominant-baseline="middle"
                              font-size="11" 
                              font-weight="600" 
                              fill="white"
                              font-family="Inter">
                            ${item.weight.toFixed(0)}%
                        </text>
                    `;
                }

                currentAngle = endAngle;
            });

            html += '</svg>';

            // Add legend
            html += `
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 11px;">
            `;

            sectors.forEach((item, index) => {
                const color = colors[index % colors.length];
                html += `
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px; flex-shrink: 0;"></div>
                        <span style="color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.sector}">${item.sector}</span>
                        <span style="color: #666; margin-left: auto; font-weight: 500;">${item.weight.toFixed(1)}%</span>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function displayWeightsTable(originalWeights, optimizedWeights, totalAmount) {
            let html = `
                <thead>
                    <tr>
                        <th>Investment Name</th>
                        <th style="text-align: right;">Expected Impact</th>
                        <th style="text-align: right;">Risk</th>
                        <th style="text-align: right;">Sharpe Ratio</th>
                        <th style="text-align: right;">P90 Impact</th>
                        <th style="text-align: center;">Original Weight</th>
                        <th style="text-align: center;">Optimized Weight</th>
                        <th style="text-align: right;">Change</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            investments.forEach((inv, i) => {
                const origWeight = originalWeights[i];
                const optWeight = optimizedWeights[i];
                const change = ((optWeight - origWeight) / origWeight * 100);
                const impactVal = inv.impactValue || 0;
                const p90 = calculateP90(impactVal, inv.variance || 0.1);
                const sharpe = impactVal / (inv.variance || 0.1);
                const sharpeColor = sharpe > 10 ? '#2e7d32' : sharpe > 7 ? '#1976d2' : sharpe > 5 ? '#f57c00' : '#c62828';
                
                html += `
                    <tr>
                        <td><strong>${inv.name}</strong></td>
                        <td style="text-align: right;">${impactVal > 0 ? impactVal.toFixed(2) + 'M tons' : 'N/A'}</td>
                        <td style="text-align: right;">±${(inv.variance || 0.1).toFixed(2)}M</td>
                        <td style="text-align: right;">
                            <span style="color: ${sharpeColor}; font-weight: 600;">${sharpe.toFixed(2)}</span>
                        </td>
                        <td style="text-align: right;">${p90.toFixed(2)}M</td>
                        <td>
                            <div class="weight-viz">
                                <div class="weight-bar-container">
                                    <div class="weight-bar-fill" style="width: ${origWeight * 100}%; background: #e0e0e0;"></div>
                                </div>
                                <span class="weight-percentage">${(origWeight * 100).toFixed(1)}%</span>
                            </div>
                        </td>
                        <td>
                            <div class="weight-viz">
                                <div class="weight-bar-container">
                                    <div class="weight-bar-fill" style="width: ${optWeight * 100}%;"></div>
                                </div>
                                <span class="weight-percentage">${(optWeight * 100).toFixed(1)}%</span>
                            </div>
                        </td>
                        <td style="text-align: right;">
                            <span class="change-indicator ${change > 0 ? 'change-positive' : change < 0 ? 'change-negative' : ''}">
                                ${change > 0 ? '+' : ''}${change.toFixed(1)}%
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody>';
            document.getElementById('weightsTable').innerHTML = html;
        }

        function displayRiskReturnAnalysis(originalWeights, optimizedWeights, covMatrix) {
            const contributions = investments.map((inv, i) => ({
                name: inv.name,
                optReturnContrib: optimizedWeights[i] * (inv.impactValue || 0),
                riskChange: (optimizedWeights[i] - originalWeights[i]) * (inv.variance || 0.1)
            }));
            
            const topReturnContributors = contributions
                .sort((a, b) => b.optReturnContrib - a.optReturnContrib)
                .slice(0, 5);
            
            const topRiskReducers = contributions
                .filter(c => c.riskChange < 0)
                .sort((a, b) => a.riskChange - b.riskChange)
                .slice(0, 5);
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                    <div class="chart-container" style="padding: 30px;">
                        <h4 style="font-family: 'Crimson Pro', serif; font-size: 16px; font-weight: 600; color: #1b5e20; margin-bottom: 20px;">Top Impact Contributors (in tons CO2e)</h4>
                        <table style="width: 100%; font-size: 12px;">
                            ${topReturnContributors.map((c, idx) => `
                                <tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 10px 0; color: #666; width: 30px;">${idx + 1}.</td>
                                    <td style="padding: 10px 0;"><strong>${c.name}</strong></td>
                                    <td style="padding: 10px 0; text-align: right; color: #1b5e20; font-weight: 500;">${c.optReturnContrib.toFixed(2)}M</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                    
                    <div class="chart-container" style="padding: 30px;">
                        <h4 style="font-family: 'Crimson Pro', serif; font-size: 16px; font-weight: 600; color: #1b5e20; margin-bottom: 20px;">Largest Risk Reductions (in tons CO2e)</h4>
                        <table style="width: 100%; font-size: 12px;">
                            ${topRiskReducers.map((c, idx) => `
                                <tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 10px 0; color: #666; width: 30px;">${idx + 1}.</td>
                                    <td style="padding: 10px 0;"><strong>${c.name}</strong></td>
                                    <td style="padding: 10px 0; text-align: right; color: #2e7d32; font-weight: 500;">${Math.abs(c.riskChange).toFixed(3)}M</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('riskReturnAnalysis').innerHTML = html;
        }

        function displayCorrelationMatrix() {
            const container = document.getElementById('correlationMatrixContainer');
            
            // Helper function to get color based on correlation value
            function getCorrelationColor(value) {
                // Clamp value between -1 and 1
                const intensity = Math.max(0, Math.min(1, Math.abs(value)));
                
                // For positive correlations, use green shades
                // Interpolate between light green (low correlation) and dark green (high correlation)
                if (value >= 0) {
                    // Dark green (1b5e20) for high correlation, light green for low
                    const r = Math.round(27 + (240 - 27) * (1 - intensity));
                    const g = Math.round(94 + (248 - 94) * (1 - intensity));
                    const b = Math.round(32 + (240 - 32) * (1 - intensity));
                    return `rgb(${r}, ${g}, ${b})`;
                } else {
                    // For negative correlations (rare), use light blue-gray
                    return `rgb(220, 240, 255)`;
                }
            }
            
            // Get text color based on background
            function getTextColor(correlation) {
                return Math.abs(correlation) > 0.5 ? 'white' : '#333';
            }
            
            // Create table header
            let html = `
                <div class="correlation-matrix-container">
                    <table class="correlation-matrix">
                        <thead>
                            <tr>
                                <th style="min-width: 180px;">Investment</th>
                                ${investments.map((inv, idx) => `<th title="${inv.name}">${idx + 1}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Create table rows
            investments.forEach((inv, i) => {
                html += '<tr>';
                // First column: investment name (abbreviated)
                const shortName = inv.name.length > 25 ? inv.name.substring(0, 22) + '...' : inv.name;
                html += `<td title="${inv.name}">${shortName}</td>`;
                
                // Correlation values
                investments.forEach((_, j) => {
                    const correlation = correlationMatrix[i][j];
                    const bgColor = getCorrelationColor(correlation);
                    const textColor = getTextColor(correlation);
                    const isDiagonal = i === j;
                    
                    html += `<td class="correlation-cell" 
                             style="background-color: ${bgColor}; color: ${textColor};"
                             title="${inv.name} ↔ ${investments[j].name}: ${correlation.toFixed(2)}">
                             ${isDiagonal ? '1.00' : correlation.toFixed(2)}
                             </td>`;
                });
                
                html += '</tr>';
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="correlation-legend">
                    <div class="correlation-legend-item">
                        <div class="correlation-legend-color" style="background-color: rgb(27, 94, 32);"></div>
                        <span>Strong Positive (0.8-1.0)</span>
                    </div>
                    <div class="correlation-legend-item">
                        <div class="correlation-legend-color" style="background-color: rgb(80, 140, 90);"></div>
                        <span>Moderate Positive (0.5-0.8)</span>
                    </div>
                    <div class="correlation-legend-item">
                        <div class="correlation-legend-color" style="background-color: rgb(140, 200, 150);"></div>
                        <span>Weak Positive (0.2-0.5)</span>
                    </div>
                    <div class="correlation-legend-item">
                        <div class="correlation-legend-color" style="background-color: rgb(240, 248, 240);"></div>
                        <span>Low/Independent (&lt;0.2)</span>
                    </div>
                </div>
                
                <div class="correlation-matrix-insight">
                    <h4>Correlation Analysis Insights</h4>
                    <p><strong>High Correlations (≥0.7):</strong> Investments with high positive correlations tend to move together, reducing diversification benefits. These pairs include similar technologies (e.g., Solar and Wind) or related sectors (e.g., Solar-Plus-Storage and SolarTech).</p>
                    <p><strong>Moderate Correlations (0.4-0.7):</strong> These relationships provide some diversification while maintaining sector exposure. Portfolio optimization benefits from mixing moderately correlated assets.</p>
                    <p><strong>Low Correlations (&lt;0.4):</strong> Investments with low correlations offer significant diversification benefits. Geothermal, Tidal Energy, and Micro-Hydro show particularly low correlations with solar/wind assets, making them valuable for risk reduction.</p>
                    <p><strong>Diagonal (1.00):</strong> Perfect self-correlation represents each investment's relationship with itself.</p>
                    <p><strong>Portfolio Impact:</strong> The optimization algorithm uses these correlations to construct portfolios that minimize risk through diversification. Lower average portfolio correlation leads to greater risk reduction potential.</p>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function generateEfficientFrontier() {
            const covMatrix = calculateCovarianceMatrix();
            const totalAmount = investments.reduce((sum, inv) => sum + inv.amount, 0);
            const originalWeights = investments.map(inv => inv.amount / totalAmount);
            const originalReturn = calculatePortfolioReturn(originalWeights);
            const originalVariance = calculatePortfolioVariance(originalWeights, covMatrix);
            
            const points = [];
            const minTarget = 15;
            const maxTarget = 40;
            const steps = 50; // Increased from 35 for smoother curve
            
            for (let i = 0; i <= steps; i++) {
                const targetReturn = minTarget + (maxTarget - minTarget) * (i / steps);
                const weights = optimizeForTarget(targetReturn, covMatrix);
                const actualReturn = calculatePortfolioReturn(weights);
                const variance = calculatePortfolioVariance(weights, covMatrix);
                const sharpe = actualReturn / variance;
                
                points.push({
                    return: actualReturn,
                    risk: variance,
                    sharpe: sharpe
                });
            }
            
            displayEfficientFrontier(points, originalReturn, originalVariance, 
                                    currentOptimizedReturn, currentOptimizedRisk);
        }

        function optimizeForTarget(targetReturn, covMatrix) {
            const maxWeight = parseFloat(document.getElementById('maxWeight').value);
            const minWeight = parseFloat(document.getElementById('minWeight').value);
            const n = investments.length;
            
            let weights = new Array(n).fill(1/n);
            const learningRate = 0.001;
            const iterations = 3000;
            
            for (let iter = 0; iter < iterations; iter++) {
                const gradient = new Array(n).fill(0);
                
                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < n; j++) {
                        gradient[i] += 2 * weights[j] * covMatrix[i][j];
                    }
                }
                
                for (let i = 0; i < n; i++) {
                    weights[i] -= learningRate * gradient[i];
                    weights[i] = Math.max(minWeight, Math.min(maxWeight, weights[i]));
                }
                
                const sum = weights.reduce((a, b) => a + b, 0);
                weights = weights.map(w => w / sum);
                
                const currentReturn = calculatePortfolioReturn(weights);
                if (Math.abs(currentReturn - targetReturn) > 0.5) {
                    const returns = investments.map(inv => inv.impactValue || 0);
                    const maxReturn = Math.max(...returns);
                    const adjustment = (targetReturn - currentReturn) / targetReturn;
                    
                    for (let i = 0; i < n; i++) {
                        weights[i] += learningRate * (returns[i] / maxReturn) * adjustment;
                    }
                    
                    const newSum = weights.reduce((a, b) => a + b, 0);
                    weights = weights.map(w => w / newSum);
                }
            }
            
            return weights;
        }

        function displayEfficientFrontier(points, origReturn, origRisk, optReturn, optRisk) {
            const container = document.getElementById('efficientFrontierContainer');
            
            // Calculate bounds including individual investments
            const allRisks = [...points.map(p => p.risk), ...investments.map(inv => inv.variance || 0.1), origRisk, optRisk];
            const allReturns = [...points.map(p => p.return), ...investments.map(inv => inv.impactValue || 0), origReturn, optReturn];
            
            const minRisk = Math.min(...allRisks) * 0.9;
            const maxRisk = Math.max(...allRisks) * 1.1;
            const minReturn = Math.min(...allReturns) * 0.9;
            const maxReturn = Math.max(...allReturns) * 1.1;
            
            const maxSharpePoint = points.reduce((max, p) => p.sharpe > max.sharpe ? p : max);
            
            const origX = 100 + ((origRisk - minRisk) / (maxRisk - minRisk)) * 720;
            const origY = 496 - ((origReturn - minReturn) / (maxReturn - minReturn)) * 396;
            
            const optX = 100 + ((optRisk - minRisk) / (maxRisk - minRisk)) * 720;
            const optY = 496 - ((optReturn - minReturn) / (maxReturn - minReturn)) * 396;
            
            const maxSharpeX = 100 + ((maxSharpePoint.risk - minRisk) / (maxRisk - minRisk)) * 720;
            const maxSharpeY = 496 - ((maxSharpePoint.return - minReturn) / (maxReturn - minReturn)) * 396;
            
            const pathData = points.map((p, i) => {
                const x = 100 + ((p.risk - minRisk) / (maxRisk - minRisk)) * 720;
                const y = 496 - ((p.return - minReturn) / (maxReturn - minReturn)) * 396;
                return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
            }).join(' ');
            
            // Create smooth curve using quadratic Bezier curves for better visual
            const smoothPath = points.map((p, i) => {
                const x = 80 + ((p.risk - minRisk) / (maxRisk - minRisk)) * 520;
                const y = 350 - ((p.return - minReturn) / (maxReturn - minReturn)) * 250;
                
                if (i === 0) {
                    return `M ${x} ${y}`;
                } else if (i === points.length - 1) {
                    return `L ${x} ${y}`;
                } else {
                    // Calculate control point for smooth curve
                    const prevX = 80 + ((points[i-1].risk - minRisk) / (maxRisk - minRisk)) * 520;
                    const prevY = 350 - ((points[i-1].return - minReturn) / (maxReturn - minReturn)) * 250;
                    const nextX = 80 + ((points[i+1].risk - minRisk) / (maxRisk - minRisk)) * 520;
                    const nextY = 350 - ((points[i+1].return - minReturn) / (maxReturn - minReturn)) * 250;
                    
                    // Smooth using quadratic bezier
                    const cpX = (prevX + nextX) / 2;
                    const cpY = (prevY + nextY) / 2;
                    
                    return `Q ${x} ${y}, ${(x + nextX) / 2} ${(y + nextY) / 2}`;
                }
            }).join(' ');
            
            const origP90 = calculateP90(origReturn, origRisk);
            const optP90 = calculateP90(optReturn, optRisk);
            
            let html = `
                <div class="chart-container">
                    <h2 class="chart-title">Efficient Frontier Analysis</h2>
                    <p class="chart-description">The efficient frontier represents the set of optimal portfolios that offer the highest expected return for a defined level of risk. Each point on the frontier represents a portfolio allocation that cannot be improved upon without increasing risk or reducing return.</p>
                    
                    <svg width="100%" height="600" viewBox="0 0 900 600" style="background: #fafafa; border: 1px solid #e0e0e0;">
                        <defs>
                            <linearGradient id="frontierGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#1b5e20;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#66bb6a;stop-opacity:1" />
                            </linearGradient>
                            <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
                                <polygon points="0 0, 8 4, 0 8" fill="#2e7d32" />
                            </marker>
                            <linearGradient id="inefficientGradient" x1="0%" y1="100%" x2="0%" y2="0%">
                                <stop offset="0%" style="stop-color:#f5f5f5;stop-opacity:0.3" />
                                <stop offset="100%" style="stop-color:#e0e0e0;stop-opacity:0.6" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Grid -->
                        ${Array.from({length: 7}, (_, i) => `
                            <line x1="100" y1="${100 + i * 66}" x2="820" y2="${100 + i * 66}" 
                                  stroke="#e8e8e8" stroke-width="1"/>
                        `).join('')}
                        ${Array.from({length: 11}, (_, i) => `
                            <line x1="${100 + i * 80}" y1="100" x2="${100 + i * 80}" y2="496" 
                                  stroke="#e8e8e8" stroke-width="1"/>
                        `).join('')}
                        
                        <!-- Axes -->
                        <line x1="100" y1="496" x2="820" y2="496" stroke="#1b5e20" stroke-width="3"/>
                        <line x1="100" y1="100" x2="100" y2="496" stroke="#1b5e20" stroke-width="3"/>
                        
                        <!-- Axis Labels -->
                        <text x="460" y="545" text-anchor="middle" font-size="15" font-weight="500" fill="#666" font-family="Inter">
                            Portfolio Risk (Standard Deviation, M tons CO2e/year)
                        </text>
                        <text x="45" y="298" text-anchor="middle" font-size="15" font-weight="500" fill="#666" font-family="Inter"
                              transform="rotate(-90, 45, 298)">
                            Expected Impact (M tons CO2e/year)
                        </text>
                        
                        <!-- Shaded inefficient region -->
                        <path d="${pathData} L 820 496 L 100 496 Z" 
                            fill="url(#inefficientGradient)" opacity="0.5"/>
                        
                        <!-- Efficient Frontier - Smooth Curve -->
                        <path d="${pathData}" 
                            stroke="url(#frontierGradient)" stroke-width="5" fill="none" 
                            stroke-linecap="round" stroke-linejoin="round"
                            filter="drop-shadow(0px 2px 4px rgba(0,0,0,0.1))"/>
                        
                        <!-- Individual Investments -->
                        ${investments.map((inv, idx) => {
                            const impactVal = inv.impactValue || 0;
                            const varianceVal = inv.variance || 0.1;
                            const invX = 100 + ((varianceVal - minRisk) / (maxRisk - minRisk)) * 720;
                            const invY = 496 - ((impactVal - minReturn) / (maxReturn - minReturn)) * 396;
                            const sharpe = impactVal / varianceVal;
                            const color = sharpe > 10 ? '#2e7d32' : sharpe > 7 ? '#1976d2' : sharpe > 5 ? '#f57c00' : '#c62828';
                            
                            return `
                                <g class="investment-point">
                                    <circle cx="${invX}" cy="${invY}" r="8" fill="${color}" opacity="0.8" stroke="white" stroke-width="2">
                                        <title>${inv.name}
Impact: ${impactVal > 0 ? impactVal + 'M tons/year' : 'N/A'}
Risk: ±${varianceVal}M tons
Sharpe: ${sharpe.toFixed(2)}
P90: ${impactVal > 0 ? calculateP90(impactVal, varianceVal).toFixed(2) + 'M' : 'N/A'}</title>
                                    </circle>
                                    <text x="${invX}" y="${invY + 2}" text-anchor="middle" font-size="11" fill="white" font-weight="700" font-family="Inter">
                                        ${idx + 1}
                                    </text>
                                </g>
                            `;
                        }).join('')}
                        
                        <!-- Frontier Points (smaller, behind individual investments) -->
                        ${points.map((p, i) => {
                            if (i % 5 !== 0) return ''; // Show every 5th point
                            const x = 100 + ((p.risk - minRisk) / (maxRisk - minRisk)) * 720;
                            const y = 496 - ((p.return - minReturn) / (maxReturn - minReturn)) * 396;
                            return `
                                <circle cx="${x}" cy="${y}" r="3" fill="#1b5e20" opacity="0.3">
                                    <title>Efficient Portfolio
                                    Return: ${p.return.toFixed(2)}M tons/year
                                    Risk: ±${p.risk.toFixed(2)}M tons
                                    Sharpe: ${p.sharpe.toFixed(2)}</title>
                                </circle>
                            `;
                        }).join('')}
                        
                        <!-- Max Sharpe Point -->
                        <circle cx="${maxSharpeX}" cy="${maxSharpeY}" r="9" fill="#66bb6a" stroke="white" stroke-width="3"/>
                        <text x="${maxSharpeX}" y="${maxSharpeY - 20}" text-anchor="middle" font-size="12" font-weight="600" fill="#66bb6a" font-family="Inter">
                            MAX SHARPE: ${maxSharpePoint.sharpe.toFixed(2)}
                        </text>
                        
                        <!-- Original Portfolio -->
                        <circle cx="${origX}" cy="${origY}" r="10" fill="none" stroke="#999" stroke-width="3" stroke-dasharray="5,5"/>
                        <text x="${origX}" y="${origY - 22}" text-anchor="middle" font-size="12" font-weight="600" fill="#666" font-family="Inter">
                            ORIGINAL
                        </text>
                        
                        <!-- Optimized Portfolio -->
                        <circle cx="${optX}" cy="${optY}" r="11" fill="#1b5e20" stroke="white" stroke-width="3"/>
                        <text x="${optX}" y="${optY - 24}" text-anchor="middle" font-size="12" font-weight="600" fill="#1b5e20" font-family="Inter">
                            OPTIMIZED
                        </text>
                        
                        <!-- Improvement Arrow -->
                        <path d="M ${origX} ${origY} L ${optX} ${optY}"
                              stroke="#2e7d32" stroke-width="3" fill="none" 
                              marker-end="url(#arrowhead)" 
                              stroke-dasharray="6,6" opacity="0.6"/>
                        
                        <!-- Axis Values -->
                        ${Array.from({length: 11}, (_, i) => {
                            const risk = minRisk + (maxRisk - minRisk) * (i / 10);
                            return `<text x="${100 + i * 80}" y="520" text-anchor="middle" font-size="11" fill="#666" font-family="Inter">
                                ${risk.toFixed(1)}
                            </text>`;
                        }).join('')}
                        
                        ${Array.from({length: 7}, (_, i) => {
                            const ret = minReturn + (maxReturn - minReturn) * (i / 6);
                            return `<text x="85" y="${504 - i * 66}" text-anchor="end" font-size="11" fill="#666" font-family="Inter">
                                ${ret.toFixed(0)}
                            </text>`;
                        }).join('')}
                    </svg>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-symbol" style="background: #1b5e20; border: 2px solid white; border-radius: 50%;"></div>
                            <span>Optimized Portfolio</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol" style="background: white; border: 2px solid #999; border-style: dashed; border-radius: 50%;"></div>
                            <span>Original Portfolio</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-symbol" style="background: #66bb6a; border: 2px solid white; border-radius: 50%;"></div>
                            <span>Maximum Sharpe Ratio</span>
                        </div>
                        <div class="legend-item">
                            <div style="width: 30px; height: 2px; background: linear-gradient(90deg, #1b5e20, #66bb6a);"></div>
                            <span>Efficient Frontier</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; padding: 20px; background: #fafafa; border: 1px solid #e0e0e0;">
                        <h4 style="font-family: 'Crimson Pro', serif; font-size: 14px; font-weight: 600; color: #1b5e20; margin-bottom: 15px;">Individual Investment Color Legend</h4>
                        <div style="display: flex; gap: 25px; flex-wrap: wrap; margin-bottom: 15px;">
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: #2e7d32; border: 1.5px solid white; border-radius: 50%;"></div>
                                <span>Excellent Sharpe (>10)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: #1976d2; border: 1.5px solid white; border-radius: 50%;"></div>
                                <span>Good Sharpe (7-10)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: #f57c00; border: 1.5px solid white; border-radius: 50%;"></div>
                                <span>Fair Sharpe (5-7)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol" style="background: #c62828; border: 1.5px solid white; border-radius: 50%;"></div>
                                <span>Poor Sharpe (<5)</span>
                            </div>
                        </div>
                        <p style="font-size: 11px; color: #666; line-height: 1.6; margin: 0;">
                            Each numbered circle represents an individual investment. Most plot below the efficient frontier, demonstrating that portfolio diversification achieves superior risk-adjusted returns compared to single investments.
                        </p>
                    </div>
                    
                    <div class="insight-box" style="margin-top: 30px;">
                        <h4 class="insight-title">Efficient Frontier Insights</h4>
                        <div class="insight-text">
                            <p style="margin-bottom: 10px;"><strong>The Efficient Frontier Curve:</strong> The curved line represents all optimal portfolio combinations that maximize expected impact for each level of risk. Each point on the curve represents a different allocation strategy across the 15 investments, with ${points.length} portfolios calculated spanning the feasible range.</p>
                            
                            <p style="margin-bottom: 10px;"><strong>Risk Reduction:</strong> The optimized portfolio reduces risk by ${(((origRisk - optRisk) / origRisk) * 100).toFixed(1)}% (from ${origRisk.toFixed(2)}M to ${optRisk.toFixed(2)}M) while maintaining ${((optReturn / origReturn) * 100).toFixed(1)}% of expected impact.</p>
                            
                            <p style="margin-bottom: 10px;"><strong>Portfolio vs. Individual Investments:</strong> All 15 individual investments (numbered circles) are plotted on the graph. Notice that nearly all individual investments sit in the shaded region below the efficient frontier, demonstrating that diversified portfolios consistently outperform single-asset strategies on a risk-adjusted basis.</p>
                            
                            <p style="margin-bottom: 10px;"><strong>P90 Analysis:</strong> With 90% confidence, the optimized portfolio will deliver at least ${optP90.toFixed(2)}M tons CO2e reduction annually, compared to ${origP90.toFixed(2)}M for the original portfolio.</p>
                            
                            <p style="margin-bottom: 10px;"><strong>Sharpe Ratio:</strong> The optimization improved risk-adjusted returns from ${(origReturn/origRisk).toFixed(2)} to ${(optReturn/optRisk).toFixed(2)}, representing a ${(((optReturn/optRisk) - (origReturn/origRisk)) / (origReturn/origRisk) * 100).toFixed(1)}% enhancement in capital efficiency.</p>
                            
                            <p><strong>Position on Frontier:</strong> The optimized portfolio sits precisely on the efficient frontier, confirming that no alternative allocation can achieve higher returns at this risk level. The maximum Sharpe ratio portfolio (${maxSharpePoint.sharpe.toFixed(2)}) represents the theoretically optimal risk-return trade-off across all possible combinations.</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 25px; background: #fafafa; border: 1px solid #e0e0e0;">
                        <h4 style="font-family: 'Crimson Pro', serif; font-size: 16px; font-weight: 600; color: #1b5e20; margin-bottom: 15px;">Individual Investment Reference</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px 20px; font-size: 11px;">
                            ${investments.map((inv, idx) => {
                                const impactVal = inv.impactValue || 0;
                                const varianceVal = inv.variance || 0.1;
                                const sharpe = impactVal / varianceVal;
                                const color = sharpe > 10 ? '#2e7d32' : sharpe > 7 ? '#1976d2' : sharpe > 5 ? '#f57c00' : '#c62828';
                                return `
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="display: inline-block; width: 20px; height: 20px; background: ${color}; color: white; text-align: center; line-height: 20px; font-weight: 600; font-size: 10px; border-radius: 2px;">${idx + 1}</span>
                                        <span style="color: #333;">${inv.name}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <p style="margin-top: 15px; font-size: 11px; color: #666; line-height: 1.6;">
                            <strong>Note:</strong> Individual investments are color-coded by Sharpe ratio (impact/risk). Green indicates excellent risk-adjusted returns (>10), blue indicates good (7-10), orange indicates fair (5-7), and red indicates poor (<5). Most individual investments plot below the efficient frontier, demonstrating the value of diversification and optimization.
                        </p>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function reoptimize() {
            optimizePortfolio();
            setTimeout(() => generateEfficientFrontier(), 500);
        }

        window.addEventListener('load', function() {
            displayCorrelationMatrix();
            optimizePortfolio();
            setTimeout(() => generateEfficientFrontier(), 1000);
        });
    </script>
</body>
</html>
